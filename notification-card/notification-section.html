<link rel="import" href="../../app-storage/app-indexeddb-mirror/app-indexeddb-mirror.html">
<link rel="import" href="../../polymerfire/firebase-auth.html">
<link rel="import" href="../../polymerfire/firebase-query.html">
<link rel="import" href="../../polymerfire/firebase-document.html">
<link rel="import" href="../../paper-dialog/paper-dialog.html">

<link rel="import" href="./notification-add.html">
<link rel="import" href="./notification-card.html">
<link rel="import" href="./notification-edit-card.html">



<dom-module id="notification-section">
  <template>
    <style>
    </style>
    <firebase-auth
        id="auth"
        app-name="sound-rebound"
        user="{{user}}">
    </firebase-auth>

    <firebase-query
      id="query"
      app-name="sound-rebound"
      path="/users/[[user.uid]]"
      data="{{notifications}}">
    </firebase-query>

    <firebase-document
      id="firebaseDoc"
      app-name="sound-rebound"
      path="/users/[[user.uid]]/[[specificNotification]]"
      data="{{editingNotification}}">
    </firebase-document>
    <!--
    <app-indexeddb-mirror
        session="[[user.uid]]"
        key="notifications"
        data="{{notifications}}"
        persisted-data="{{persistedNotifications}}">
    </app-indexeddb-mirror>
    -->
    <template is="dom-repeat" items="[[notifications]]" as="notification">
      <notification-card single-note="[[notification]]" ></notification-card>
    </template>
    <notification-add list-of-notification-names="[[listNotificationNames]]"></notification-add>

    <paper-dialog id="editNotificationModule" modal="false" style="width:800px">
      <notification-edit-card id="editingNotificationCard" single-note="[[editingNotification]]"></notification-edit-card>
    </paper-dialog>
  </template>
  <script>
    Polymer({
      is: 'notification-section',
      properties:{
        listNotificationNames:{
          type: Array,
          value: function(){
            return [];
          }
        },
        notifications:{
          type: Array,
          value: function(){
            return [];
          }
        },
        specificNotification:{
          type: String,
          value: "default"
        }

      },
      
      observers: [
        '_updateListNotificationNames(notifications.*)'
      ],
      
      listeners: {
        "editNotification": "_editNotification",
        'updateDisabledValue': '_updateDisabledValue',
        'deleteNotification' : '_deleteNotification',
        'addNotification' : "_addNotification",

        "closeNotificationEdit": "_closeEditingNotificationCard",
        "submitNotification": "_submitNotification"
      },

      ready: function(){
        console.log("opening");
        //this.$.editNotificationModule.open();
      },
      _editNotification: function(e){
        this.specificNotification = e.detail.singleNote.$key;
        this.$.editNotificationModule.open();
      },
      _updateDisabledValue: function(e){
        console.log(e.detail.disabledNotification);
        this.$.query.ref.child(e.detail.$key).update({"disabledNotification":e.detail.disabledNotification}); 
      },
      _deleteNotification: function(e){
        //this.$.query.ref.child(e.detail.$key).update("disabledNotification", e.detail.disabledNotification);
        this.$.query.ref.child(e.detail.$key).remove();
      },
      _addNotification: function(e){
        this.$.query.ref.push(e.detail.newNotification);
      },
      _closeEditingNotificationCard: function(){
        this.$.editNotificationModule.close();
      },
      _submitNotification: function(e){
        
        var firebaseDoc = this.$.firebaseDoc;
        var key = e.detail.singleNote.$key;
        delete e.detail.singleNote.$key;

        firebaseDoc.data = "";
        firebaseDoc.data = e.detail.singleNote;

        console.log("submited notification");

        
        e.detail.singleNote.$key = key;

        this.$.editNotificationModule.close();
        
      },
      /*
      

      basics behind the ovservers
      http://stackoverflow.com/questions/38264330/firebase-query-data-observer-not-firing
      */
      _updateListNotificationNames: function(newData){
        
        /*if newData is not defined that meens that there 
          no data to look at so stop. 
          this is important because the first values is []*/
        if(typeof newData.base !== "undefined"){
          /*
          check to see if we disabled a notification.  We need to do this
          becuase notifications is going to change forces updateListNotificationNames to fire.
          This is imortant because listNotificationNames hasen't changed.  Saving some processing cycles.
          */
          if(newData.base.length != this.listNotificationNames.length){


            var tempNotificationList = [];
            var data = this.$.query.data;
            for(var i =0; i < data.length; i++){
                if(data[i]['name'] != null && data[i]['name'] != undefined){
                   tempNotificationList.push(data[i]['name']);
                }
            }
            console.log("going through");

            this.listNotificationNames = tempNotificationList;
          }
        }
      }
    });
  </script>
</dom-module>
